name: Check RSpec Version

on:
  schedule:
    - cron: '0 10 1 1,7 *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get latest stable RSpec version
        id: latest
        run: |
          latest=$(curl -sf https://rubygems.org/api/v1/versions/rspec.json \
            | jq -r '[.[] | select(.prerelease == false)] | .[0].number')
          minor=$(echo "$latest" | cut -d. -f1,2)
          echo "version=$latest" >> "$GITHUB_OUTPUT"
          echo "minor=$minor" >> "$GITHUB_OUTPUT"
          echo "Latest stable RSpec: $latest (minor: $minor)"

      - name: Get current Appraisals versions
        id: appraisals
        run: |
          versions=$(grep -oP '~> \K[0-9]+\.[0-9]+' Appraisals | sort -V | tr '\n' ' ')
          highest=$(echo "$versions" | awk '{print $NF}')
          echo "versions=$versions" >> "$GITHUB_OUTPUT"
          echo "highest=$highest" >> "$GITHUB_OUTPUT"
          echo "Current Appraisals versions: $versions"
          echo "Highest: $highest"

      - name: Create issue if update needed
        if: steps.latest.outputs.minor != '' && steps.appraisals.outputs.highest != steps.latest.outputs.minor
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          title="ci: add RSpec ${{ steps.latest.outputs.minor }} to test matrix"
          existing=$(gh issue list --label ci --state open --search "$title" --json number --jq 'length')
          if [ "$existing" -eq 0 ]; then
            body="A new RSpec version is available."
            body="$body\n\n**Latest stable:** ${{ steps.latest.outputs.version }}"
            body="$body\n**Current Appraisals:** ${{ steps.appraisals.outputs.versions }}"
            echo -e "$body" | gh issue create --title "$title" --label ci --body-file -
          else
            echo "Issue already exists, skipping."
          fi
